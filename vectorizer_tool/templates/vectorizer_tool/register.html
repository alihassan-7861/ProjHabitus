 {% extends 'vectorizer_tool/main.html' %} {% load static %} {% block content %}
<style>
  :root {
    --accent: #ff503c;
    --text-dark: #3c231e;
    --text-light: #ffffff;
  }

 .canvas-size-section {
  text-align: center;
  margin: 30px 0;
}

.canvas-options {
  display: flex;
  justify-content: center;
  gap: 20px;
  flex-wrap: wrap;
}
#canvasSizeSelector {
  display: none;
}

.canvas-box {
  border: 2px solid #999;
  border-radius: 10px;
  padding: 20px 30px;
  cursor: pointer;
  position: relative;
  background: #fff;
  transition: all 0.3s ease;
  min-width: 120px;
  text-align: center;
}

.canvas-box:hover {
  border-color: var(--accent);
  transform: translateY(-5px);
}

.canvas-box.selected {
  border-color: var(--accent);
  background: #f8f8f8;
}

.canvas-box.selected .canvas-choice {
  position: absolute;
  bottom: -20px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--accent);
  color: white;
  padding: 5px 15px;
  border-radius: 20px;
  font-size: 13px;
  box-shadow: 0 5px 10px rgba(0,0,0,0.1);
}

.canvas-box.popular .canvas-popular {
  background: #3c231e;
  color: white;
  font-size: 12px;
  padding: 3px 10px;
  border-radius: 12px;
  margin-top: 8px;
  display: inline-block;
}


  /* NEW: Box Requirements Styles */
  .box-requirements-section {
    margin: 30px;
    padding: 30px;
    background: linear-gradient(135deg, #f5f7fa 0%, #f5f7fa 100%);
    border-radius: 20px;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
  }

  .box-requirements-title {
    font-size: 1.8em;
    color: var(--text-dark);
    margin-bottom: 20px;
    text-align: center;
    font-weight: 700;
  }

  .box-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-top: 20px;
  }

  .box-item {
    background: white;
    padding: 20px;
    border-radius: 15px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: center;
    gap: 20px;
    transition: all 0.3s ease;
    border: 2px solid transparent;
  }

  .box-item:hover {
    transform: translateY(-8px);
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
    border-color: var(--accent);
  }

  .color-preview {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    border: 3px solid #ddd;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  }

  .box-info {
    flex: 1;
  }

  .box-count {
    font-size: 24px;
    font-weight: bold;
    color: var(--accent);
    margin-bottom: 5px;
  }

  .box-label {
    font-size: 16px;
    color: var(--text-dark);
    font-weight: 500;
  }

  .box-summary {
    margin-top: 30px;
    padding: 20px;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 15px;
    text-align: center;
    font-weight: bold;
    font-size: 20px;
    color: var(--text-dark);
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
  }

  .box-summary .total-highlight {
    color: var(--accent);
    font-size: 1.2em;
    text-shadow: 0 2px 4px rgba(255, 80, 60, 0.3);
  }

  @media (max-width: 768px) {
    .box-grid {
      grid-template-columns: 1fr;
    }

    .box-requirements-section {
      margin: 15px;
      padding: 20px;
    }
  }
</style>
<div class="container">
  <div class="header">
    <h1 class="page-title">Paint-by-Number PDF Generator</h1>
    <div class="description">
      <div class="indicator"></div>
      Select an image (must use the 24-color palette) to generate your
      paint-by-number file.
    </div>
  </div>

  <div class="color-palette-section">
    <div class="compact-grid" id="compactGrid"></div>
  </div>

  <div class="image-section">
    <div class="image-container">
      <div class="image-panel">
        <div class="panel-title">Original Image</div>
        <div class="upload-area">
         <div class="uploaded-wrapper {% if  vector_url %}shown{% else %}hidden{% endif %}" id="uploadedWrapper">
            <img id="uploadedImage" src="{{ vector_url }}" alt="Uploaded image" />
            <button class="browse-btn" type="button" onclick="triggerImageInput()">
              Change Image
            </button>
          </div>
        </div>
      </div>

      <div class="image-panel">
        <div class="panel-title">Generated Output</div>
        <div class="output-area">
          <div class="output-placeholder" id="outputPlaceholder">
            <p>Your paint-by-number file will appear here</p>
          </div>
          <div class="hidden" id="outputResult">
            <p>
              File generated successfully. Click download button to download!
            </p>
            <object id="outputPreview" type="image/svg+xml" data="" width="100%" height="600px">
              SVG preview failed.
            </object>

          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="box-requirements-section hidden" id="boxRequirementsSection">
    <div class="box-requirements-title">Color Box Requirements</div>
    <div class="box-grid" id="boxGrid"></div>
    <div class="box-summary" id="boxSummary"></div>
  </div>

  <div
    id="loadingSpinner"
    class="hidden"
    style="text-align: center; margin-top: 20px"
  >
    <img
      src="{% static 'images/spinner.png' %}"
      alt="Loading..."
      width="50"
      height="50"
    />
  </div>

  <div style="text-align: center; margin-top: 30px">
    <button
      class="generate-btn"
      id="generateBtn"
      onclick="generateSkeleton()"
      disabled
    >
      Generate
    </button>
  </div>

<div class="canvas-size-section" id="canvasSizeSelector">
  <p style="margin-bottom: 10px;">Choose your canvas size:</p>
  <div class="canvas-options">
    <div class="canvas-box popular" data-size="45x30">
      <div class="canvas-label">45 × 30 cm</div>
      <div class="canvas-popular">Deine Wahl</div>
    </div>
    <div class="canvas-box popular" data-size="60x40">
      <div class="canvas-label">60 × 40 cm</div>
      <div class="canvas-popular">Most popular</div>
    </div>
    <div class="canvas-box" data-size="90x60">
      <div class="canvas-label">90 × 60 cm</div>
    </div>
  </div>
</div>


<!-- Hidden by default -->
<div id="pdfDownloadSection" class="canvas-size-section" style="display: none;">
  <h3>📄 Download Paint-by-Number PDF</h3>
  <div class="canvas-options">
    <div class="canvas-box" onclick="downloadPDF('45x30')">
      <span>Download PDF</span><br><strong>45×30 cm</strong>
    </div>
    <div class="canvas-box" onclick="downloadPDF('60x40')">
      <span>Download PDF</span><br><strong>60×40 cm</strong>
    </div>
    <div class="canvas-box" onclick="downloadPDF('90x60')">
      <span>Download PDF</span><br><strong>90×60 cm</strong>
    </div>
  </div>
</div>




</div>
<script>

const colorPalette = [
  { hex: "#FFFFFF", name: "White" },
  { hex: "#1A1A1A", name: "Black" },
  { hex: "#DADADA", name: "Light Gray" },
  { hex: "#999999", name: "Medium Gray" },
  { hex: "#B7D79A", name: "Light Green" },
  { hex: "#4C8C4A", name: "Medium Green" },
  { hex: "#2E472B", name: "Dark Green" },
  { hex: "#FDE74C", name: "Bright Yellow" },
  { hex: "#F5C243", name: "Golden Yellow" },
  { hex: "#F28C28", name: "Orange" },
  { hex: "#C85A27", name: "Dark Orange" },
  { hex: "#F88379", name: "Light Red" },
  { hex: "#D63E3E", name: "Medium Red" },
  { hex: "#8C1C13", name: "Dark Red" },
  { hex: "#AED9E0", name: "Light Blue" },
  { hex: "#4A90E2", name: "Medium Blue" },
  { hex: "#1B3B6F", name: "Dark Blue" },
  { hex: "#3CCFCF", name: "Cyan" },
  { hex: "#FBE3D4", name: "Light Peach" },
  { hex: "#D5A97B", name: "Beige" },
  { hex: "#5C3B28", name: "Brown" },
  { hex: "#F5E0C3", name: "Cream" },
  { hex: "#A24B7B", name: "Purple" },
  { hex: "#FFCFD8", name: "Light Pink" },
];

let currentBoxRequirements = {};

function generateLabel(index) {
  const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  return `${letters[Math.floor(index / 10)]}${index % 10}`;
}

function getContrastColor(hex) {
  const r = parseInt(hex.substr(1, 2), 16);
  const g = parseInt(hex.substr(3, 2), 16);
  const b = parseInt(hex.substr(5, 2), 16);
  const brightness = (r * 299 + g * 587 + b * 114) / 1000;
  return brightness > 128 ? "#000" : "#fff";
}

function showUploadedImage(imageSrc) {
  const uploadedImage = document.getElementById("uploadedImage");
  uploadedImage.src = imageSrc;
  uploadedImage.alt = "Uploaded image";

  document.getElementById("uploadedWrapper").classList.remove("hidden");
  document.getElementById("uploadPlaceholder").classList.add("hidden");
  document.getElementById("generateBtn").disabled = false;

  sessionStorage.setItem("vectorizedImage", imageSrc);
}

function createCompactGrid() {
  const grid = document.getElementById("compactGrid");
  colorPalette.forEach((color, index) => {
    const label = generateLabel(index);
    const dot = document.createElement("div");
    dot.className = "color-dot";
    dot.style.backgroundColor = color.hex;
    dot.style.color = getContrastColor(color.hex);
    dot.innerHTML = `${label}<div class="tooltip"><strong>${color.name}</strong><br>${color.hex}<br>Label: ${label}</div>`;
    grid.appendChild(dot);
  });
}

function displayBoxRequirements(boxRequirements) {
  const boxGrid = document.getElementById("boxGrid");
  const boxSummary = document.getElementById("boxSummary");
  boxGrid.innerHTML = "";
  let totalBoxes = 0;

  const sortedRequirements = Object.entries(boxRequirements).sort(([a], [b]) => a.localeCompare(b));

  sortedRequirements.forEach(([label, boxCount]) => {
    totalBoxes += boxCount;
    const colorIndex = colorPalette.findIndex((_, index) => generateLabel(index) === label);
    const color = colorPalette[colorIndex] || { hex: "#ccc", name: "Unknown" };

    const boxItem = document.createElement("div");
    boxItem.className = "box-item";
    boxItem.innerHTML = `
      <div class="color-preview" style="background-color: ${color.hex}; color: ${getContrastColor(color.hex)}">
        ${label}
      </div>
      <div class="box-info">
        <div class="box-count">${boxCount} box${boxCount > 1 ? "es" : ""}</div>
        <div class="box-label">${color.name}</div>
      </div>
    `;
    boxGrid.appendChild(boxItem);
  });

  boxSummary.innerHTML = `📦 Total Color Boxes Required: <span class="total-highlight">${totalBoxes}</span>`;
}

function getCookie(name) {
  return document.cookie
    .split("; ")
    .find((row) => row.startsWith(name + "="))
    ?.split("=")[1] || "";
}

function generateSkeleton() {
  const formData = new FormData();
  formData.append("format", "svg");
  formData.append("preview", "true");

  const uploadedImg = document.getElementById("uploadedImage");
  const imgSrc = uploadedImg?.getAttribute("src");

  if (imgSrc) {
    formData.append("image_url", imgSrc);
  } else {
    alert("❌ No image found to upload.");
    return;
  }

  document.getElementById("loadingSpinner").classList.remove("hidden");
  document.getElementById("generateBtn").disabled = true;

  fetch("/generate-pbn/", {
    method: "POST",
    headers: { "X-CSRFToken": getCookie("csrftoken") },
    body: formData,
  })
    .then((res) => res.ok ? res.json() : Promise.reject("Generation failed."))
    .then((data) => {
  if (data.svg_url || data.svg_file_url) {
    console.log("✅ SVG generated successfully.");

    // ✅ Show alert message
    alert("✅ Paint-by-Number image generated successfully!");

    // Optional: log or store job info
    console.log("SVG URL:", data.svg_file_url);
    console.log("JPEG URL:", data.jpeg_file_url);
    console.log("Job ID:", data.job_id);

    // ✅ Optionally enable a download button or store the link somewhere
   const canvasSelector = document.getElementById("canvasSizeSelector");
    if (canvasSelector) {
           canvasSelector.style.display = "block";
      console.log("✅ canvasSizeSelector revealed.");
    } else {
      console.warn("❌ canvasSizeSelector not found.");
    }
      document.getElementById("pdfDownloadSection").style.display = "block";

  } else {
    alert("❌ SVG generation failed.");
  }

  // Hide loading and enable buttons
  document.getElementById("loadingSpinner").classList.add("hidden");
  document.getElementById("generateBtn").disabled = false;



      // if (data.box_requirements && Object.keys(data.box_requirements).length > 0) {
      //   currentBoxRequirements = data.box_requirements;
      //   displayBoxRequirements(currentBoxRequirements);
      //   document.getElementById("boxRequirementsSection").classList.remove("hidden");
      // } else {
      //   document.getElementById("boxRequirementsSection").classList.add("hidden");
      // }

      document.getElementById("outputPlaceholder").classList.add("hidden");
      document.getElementById("outputResult").classList.remove("hidden");
    })
    .catch((err) => alert("❌ Error: " + err))
    .finally(() => {
      document.getElementById("loadingSpinner").classList.add("hidden");
      document.getElementById("generateBtn").disabled = false;
    });
}

// function showDownloadDialog() {
//   document.getElementById("downloadDialog")?.classList.remove("hidden");
// }

// async function downloadInSelectedFormat() {
//   const format = document.querySelector('input[name="format"]:checked')?.value;
//   const imageUrl = sessionStorage.getItem("vectorizedImage");
//   if (!format || !imageUrl) return alert("Please select a format and ensure the image is ready.");

//   document.getElementById("downloadDialog")?.classList.add("hidden");
//   document.getElementById("loadingSpinner")?.classList.remove("hidden");

//   const formData = new FormData();
//   formData.append("format", format);

//   try {
//     const responseImg = await fetch(imageUrl);
//     const blob = await responseImg.blob();
//     formData.append("image", new File([blob], "vector_input.png", { type: blob.type }));

//     const response = await fetch("/generate-pbn/", {
//       method: "POST",
//       headers: { "X-CSRFToken": getCookie("csrftoken") },
//       body: formData,
//     });

//     if (!response.ok) throw new Error("Failed to process image.");

//     const blobResult = await response.blob();
//     const blobUrl = window.URL.createObjectURL(blobResult);
//     const a = document.createElement("a");
//     a.href = blobUrl;
//     a.download = format === "pdf" ? "habitus.pdf" : "habitus.jpeg";
//     document.body.appendChild(a);
//     a.click();
//     document.body.removeChild(a);
//     window.URL.revokeObjectURL(blobUrl);
//   } catch (error) {
//     console.error("Download error:", error);
//     alert("Download failed. Please try again.");
//   } finally {
//     document.getElementById("loadingSpinner")?.classList.add("hidden");
//   }
// }
// async function downloadInSelectedFormat() {
//   const format = document.querySelector('input[name="format"]:checked')?.value;
//   const imageUrl = window.generatedImageURL;

//   if (!format || !imageUrl) {
//     alert("Please select a format and ensure the image is ready.");
//     return;
//   }

//   document.getElementById("downloadDialog")?.classList.add("hidden");
//   document.getElementById("loadingSpinner")?.classList.remove("hidden");

//   if (format === "jpeg" || format === "png") {
//     const a = document.createElement("a");
//     a.href = imageUrl;
//     a.download = `habitus.${format}`;
//     document.body.appendChild(a);
//     a.click();
//     document.body.removeChild(a);
//     document.getElementById("loadingSpinner")?.classList.add("hidden");
//   } else if (format === "pdf") {
//     const formData = new FormData();
//     formData.append("format", "pdf");
//     formData.append("image_url", imageUrl); 

//     try {
//       const response = await fetch("/generate-pbn/", {
//         method: "POST",
//         headers: {
//           "X-CSRFToken": getCookie("csrftoken"),
//         },
//         body: formData,
//       });

//       if (!response.ok) {
//         throw new Error(`Download failed with status ${response.status}`);
//       }

//       const blob = await response.blob();
//       const a = document.createElement("a");
//       a.href = window.URL.createObjectURL(blob);
//       a.download = "habitus.pdf";
//       document.body.appendChild(a);
//       a.click();
//       document.body.removeChild(a);
//     } catch (error) {
//       alert("Failed to download PDF. Please try again.");
//       console.error(error);
//     } finally {
//       document.getElementById("loadingSpinner")?.classList.add("hidden");
//     }
//   }
// }



const uploadArea = document.querySelector(".upload-area");
uploadArea.addEventListener("dragover", (e) => {
  e.preventDefault();
  uploadArea.classList.add("dragover");
});
uploadArea.addEventListener("dragleave", (e) => {
  e.preventDefault();
  uploadArea.classList.remove("dragover");
});
uploadArea.addEventListener("drop", (e) => {
  e.preventDefault();
  uploadArea.classList.remove("dragover");
  const files = e.dataTransfer.files;
  if (files.length > 0 && files[0].type.startsWith("image/")) {
    document.getElementById("imageInput").files = files;
    handleFileSelect({ target: { files } });
  }
});
window.addEventListener("DOMContentLoaded", () => {
  createCompactGrid();  // ← Add this line

  const uploadedImage = document.getElementById("uploadedImage");
  const generateBtn = document.getElementById("generateBtn");

  if (uploadedImage && uploadedImage.src && !uploadedImage.src.includes("placeholder")) {
    generateBtn.disabled = false;
  }
});

document.addEventListener("DOMContentLoaded", function () {
    console.log("DOM fully loaded and parsed");

    const canvasBoxes = document.querySelectorAll(".canvas-box");
    console.log("Found canvasBoxes:", canvasBoxes.length);

    canvasBoxes.forEach((box, index) => {
        console.log(`Attaching click handler to canvasBox #${index + 1}`, box);
        box.addEventListener("click", function () {
            const size = box.getAttribute("data-size");
            console.log("Clicked box with data-size:", size);
            if (!size) {
                console.warn("No size found on clicked box.");
                return;
            }

            const url = `/download-resized-jpeg/?size=${encodeURIComponent(size)}`;
            console.log("Generated URL for download:", url);

            const a = document.createElement('a');
            a.href = url;
            a.download = `pbn-${size}.jpeg`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });
    });
});


 function downloadPDF(size) {
    const statusDiv = document.getElementById("download-status");
    if (statusDiv) statusDiv.textContent = "Preparing PDF…";

    const downloadUrl = `/download-resized-pdf/?size=${size}`;
    const a = document.createElement("a");
    a.href = downloadUrl;
    a.download = `pbn_${size}.pdf`;
    a.style.display = "none";
    document.body.appendChild(a);

    setTimeout(() => {
        a.click();
        document.body.removeChild(a);
        if (statusDiv) statusDiv.textContent = `✅ PDF ${size}cm downloading…`;
    }, 100);
}


</script>
{% endblock content %}




